- route:
    id: route-1200
    from:
      id: from-9847
      uri: direct
      parameters:
        name: store
      steps:
        - split:
            id: split-records
            steps:
              - log:
                  id: log-record
                  loggingLevel: DEBUG
                  message: "Processing record: ${body}"
              - setProperty:
                  jq:
                    expression: .traceId
                    resultType: java.lang.String
                  name: traceId
              - setProperty:
                  name: currentRecord
                  simple: ${body}
              - setHeader:
                  name: CamelInfinispanKey
                  simple: otel-${exchangeProperty.traceId}
              - setHeader:
                  constant: GET
                  name: CamelInfinispanOperation
              - to:
                  uri: infinispan:events
              - choice:
                  otherwise:
                    steps:
                      - setBody:
                          simple: ${exchangeProperty.currentRecord}
                      - setBody:
                          jq:
                            expression: "[.]"
                            resultType: java.lang.String
                  when:
                    - steps:
                        - setHeader:
                            name: existingRecords
                            simple: ${body}
                        - setBody:
                            simple: ${exchangeProperty.currentRecord}
                        - setBody:
                            jq:
                              expression: (header("existingRecords") | fromjson) + [.] |
                                sort_by(.timeUnixNano)
                              resultType: java.lang.String
                      simple: ${body} != null && ${body} != ''
              - setHeader:
                  name: CamelInfinispanKey
                  simple: otel-${exchangeProperty.traceId}
              - setHeader:
                  name: CamelInfinispanValue
                  simple: ${body}
              - setHeader:
                  constant: PUT
                  name: CamelInfinispanOperation
              - setHeader:
                  constant: "300"
                  name: CamelInfinispanLifespanTime
              - setHeader:
                  constant: SECONDS
                  name: CamelInfinispanLifespanTimeUnit
              - to:
                  uri: infinispan:events
              - setBody:
                  simple: ${exchangeProperty.currentRecord}
              - log:
                  id: log-stored
                  message: |-
                    Stored record for traceId: ${exchangeProperty.traceId}
              - choice:
                  when:
                    - steps:
                        - log:
                            message: "Adding ERROR log to events-to-process cache for traceId:
                              ${exchangeProperty.traceId}"
                        - setHeader:
                            name: CamelInfinispanKey
                            simple: ${exchangeProperty.traceId}
                        - setHeader:
                            name: CamelInfinispanValue
                            simple: ${exchangeProperty.traceId}
                        - setHeader:
                            constant: PUTIFABSENT
                            name: CamelInfinispanOperation
                        - to:
                            uri: infinispan:events-to-process
                      jq:
                        expression: .severityText == "ERROR"
            expression:
              jsonpath:
                expression: $[*]
                writeAsString: true

- route:
    id: route-expired-events
    from:
      uri: infinispan:events-to-process
      parameters:
        eventTypes: CLIENT_CACHE_ENTRY_EXPIRED
      steps:
        - setBody:
            simple: ${header.CamelInfinispanKey}
        - log:
            message: "Expired cache entry received, sending to JMS queue: ${body}"
        - to:
            uri: jms:{{camel.jms.queue.error-logs}}
